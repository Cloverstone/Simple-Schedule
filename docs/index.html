
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Simple Scheduler</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" type="text/css" href="assets/css/font-awesome.min.css">

    <link rel="stylesheet" type='text/css' href="assets/css/bootstrap.min.css">

    <link rel="stylesheet" type='text/css' href="assets/css/bootstrap-datepicker.min.css">
    <link rel="stylesheet" type="text/css" href="assets/css/colorpicker.min.css">
   
    <link href="assets/css/dashboard.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
<style>

/* .c3-lines {
    display: none;
} */
body{
  padding:0;margin:0;
  /* background: #005a43; */
  /* background-image:radial-gradient(#fff,rgb(228,241,221) 60%); */
  /* background-repeat:no-repeat */
}
.navbar-default .navbar-nav>li>a{color:#ddd}
.navbar-default .navbar-nav>li>a:hover{color:#fff}
/*#home a img,*/
.device{
  opacity:85%
}
/*#home a img:hover,*/.device:hover{
  opacity:95%
}
a{color:#333;}
a:hover,a:focus{text-decoration:none;color:#333;}
.chart:empty::before{
  background-image:url("assets/img/skeleton.png");
  background-size: 300px auto;
  background-repeat: no-repeat;
  background-position: center center;
  content:"";
  display:block;
  height:300px;
  opacity: 3%;
}






.wrapper {
  display: grid;
  grid-template-columns:
    1fr
    min(1210px, 100%)
    1fr;
}
.wrapper > * {
  grid-column: 2;
}
.full-bleed {
  width: 100%;
  grid-column: 1 / 4;
}
.column{position:relative}
.cursor{
  position:absolute;
  top:0;
  height: 100%;
  outline:solid 0px yellow;
  width:1px;
  background:#3275ca;
  box-shadow:0 0 3px #3275ca;
  z-index: 2;
}
.cursor::before{
  content:'';
  display:block;
  border-radius:5px;
  width:11px;
  height:11px;
  position: absolute;
  bottom:-5px;
  left: -5px;
  box-shadow: rgb(50, 117, 202) 0px 0px 3px;
  background: rgb(50, 117, 202);
}
.event{
  text-align:center;outline: solid 1px 1px 1px 1px;
  position:absolute;top:0;height: 100%;white-space: nowrap;
  /*overflow: hidden;text-overflow: ellipsis;*/
  border:0px;
  
}
.event:hover{
  z-index: 1;
}
.event:focus{border: solid 2px;outline:solid 1px #808080}
a[href], input[type='submit'], input[type='image'], label[for], select, button, .pointer {
       cursor: pointer;
}
.sortable{border:solid 1px #aaa;border-bottom:0}
.sortable-ghost{border:solid 1px #aaa;}
#myModalf0 .modal-dialog{width: 900px;}
.toast-title{font-weight:700}.toast-message{-ms-word-wrap:break-word;word-wrap:break-word}.toast-message a,.toast-message label{color:#FFF}.toast-message a:hover{color:#CCC;text-decoration:none}.toast-close-button{position:relative;right:-.3em;top:-.3em;float:right;font-size:20px;font-weight:700;color:#FFF;-webkit-text-shadow:0 1px 0 #fff;text-shadow:0 1px 0 #fff;opacity:.8;-ms-filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=80);filter:alpha(opacity=80);line-height:1}.toast-close-button:focus,.toast-close-button:hover{color:#000;text-decoration:none;cursor:pointer;opacity:.4;-ms-filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=40);filter:alpha(opacity=40)}.rtl .toast-close-button{left:-.3em;float:left;right:.3em}button.toast-close-button{padding:0;cursor:pointer;background:0 0;border:0;-webkit-appearance:none}.toast-top-center{top:0;right:0;width:100%}.toast-bottom-center{bottom:0;right:0;width:100%}.toast-top-full-width{top:0;right:0;width:100%}.toast-bottom-full-width{bottom:0;right:0;width:100%}.toast-top-left{top:12px;left:12px}.toast-top-right{top:12px;right:12px}.toast-bottom-right{right:12px;bottom:12px}.toast-bottom-left{bottom:12px;left:12px}#toast-container{position:fixed;z-index:999999;pointer-events:none}#toast-container *{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}#toast-container>div{position:relative;pointer-events:auto;overflow:hidden;margin:0 0 6px;padding:15px 15px 15px 50px;width:300px;-moz-border-radius:3px;-webkit-border-radius:3px;border-radius:3px;background-position:15px center;background-repeat:no-repeat;-moz-box-shadow:0 0 12px #999;-webkit-box-shadow:0 0 12px #999;box-shadow:0 0 12px #999;color:#FFF;opacity:.8;-ms-filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=80);filter:alpha(opacity=80)}#toast-container>div.rtl{direction:rtl;padding:15px 50px 15px 15px;background-position:right 15px center}#toast-container>div:hover{-moz-box-shadow:0 0 12px #000;-webkit-box-shadow:0 0 12px #000;box-shadow:0 0 12px #000;opacity:1;-ms-filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=100);filter:alpha(opacity=100);cursor:pointer}#toast-container>.toast-info{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAGwSURBVEhLtZa9SgNBEMc9sUxxRcoUKSzSWIhXpFMhhYWFhaBg4yPYiWCXZxBLERsLRS3EQkEfwCKdjWJAwSKCgoKCcudv4O5YLrt7EzgXhiU3/4+b2ckmwVjJSpKkQ6wAi4gwhT+z3wRBcEz0yjSseUTrcRyfsHsXmD0AmbHOC9Ii8VImnuXBPglHpQ5wwSVM7sNnTG7Za4JwDdCjxyAiH3nyA2mtaTJufiDZ5dCaqlItILh1NHatfN5skvjx9Z38m69CgzuXmZgVrPIGE763Jx9qKsRozWYw6xOHdER+nn2KkO+Bb+UV5CBN6WC6QtBgbRVozrahAbmm6HtUsgtPC19tFdxXZYBOfkbmFJ1VaHA1VAHjd0pp70oTZzvR+EVrx2Ygfdsq6eu55BHYR8hlcki+n+kERUFG8BrA0BwjeAv2M8WLQBtcy+SD6fNsmnB3AlBLrgTtVW1c2QN4bVWLATaIS60J2Du5y1TiJgjSBvFVZgTmwCU+dAZFoPxGEEs8nyHC9Bwe2GvEJv2WXZb0vjdyFT4Cxk3e/kIqlOGoVLwwPevpYHT+00T+hWwXDf4AJAOUqWcDhbwAAAAASUVORK5CYII=)!important}#toast-container>.toast-error{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAHOSURBVEhLrZa/SgNBEMZzh0WKCClSCKaIYOED+AAKeQQLG8HWztLCImBrYadgIdY+gIKNYkBFSwu7CAoqCgkkoGBI/E28PdbLZmeDLgzZzcx83/zZ2SSXC1j9fr+I1Hq93g2yxH4iwM1vkoBWAdxCmpzTxfkN2RcyZNaHFIkSo10+8kgxkXIURV5HGxTmFuc75B2RfQkpxHG8aAgaAFa0tAHqYFfQ7Iwe2yhODk8+J4C7yAoRTWI3w/4klGRgR4lO7Rpn9+gvMyWp+uxFh8+H+ARlgN1nJuJuQAYvNkEnwGFck18Er4q3egEc/oO+mhLdKgRyhdNFiacC0rlOCbhNVz4H9FnAYgDBvU3QIioZlJFLJtsoHYRDfiZoUyIxqCtRpVlANq0EU4dApjrtgezPFad5S19Wgjkc0hNVnuF4HjVA6C7QrSIbylB+oZe3aHgBsqlNqKYH48jXyJKMuAbiyVJ8KzaB3eRc0pg9VwQ4niFryI68qiOi3AbjwdsfnAtk0bCjTLJKr6mrD9g8iq/S/B81hguOMlQTnVyG40wAcjnmgsCNESDrjme7wfftP4P7SP4N3CJZdvzoNyGq2c/HWOXJGsvVg+RA/k2MC/wN6I2YA2Pt8GkAAAAASUVORK5CYII=)!important}#toast-container>.toast-success{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAADsSURBVEhLY2AYBfQMgf///3P8+/evAIgvA/FsIF+BavYDDWMBGroaSMMBiE8VC7AZDrIFaMFnii3AZTjUgsUUWUDA8OdAH6iQbQEhw4HyGsPEcKBXBIC4ARhex4G4BsjmweU1soIFaGg/WtoFZRIZdEvIMhxkCCjXIVsATV6gFGACs4Rsw0EGgIIH3QJYJgHSARQZDrWAB+jawzgs+Q2UO49D7jnRSRGoEFRILcdmEMWGI0cm0JJ2QpYA1RDvcmzJEWhABhD/pqrL0S0CWuABKgnRki9lLseS7g2AlqwHWQSKH4oKLrILpRGhEQCw2LiRUIa4lwAAAABJRU5ErkJggg==)!important}#toast-container>.toast-warning{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAGYSURBVEhL5ZSvTsNQFMbXZGICMYGYmJhAQIJAICYQPAACiSDB8AiICQQJT4CqQEwgJvYASAQCiZiYmJhAIBATCARJy+9rTsldd8sKu1M0+dLb057v6/lbq/2rK0mS/TRNj9cWNAKPYIJII7gIxCcQ51cvqID+GIEX8ASG4B1bK5gIZFeQfoJdEXOfgX4QAQg7kH2A65yQ87lyxb27sggkAzAuFhbbg1K2kgCkB1bVwyIR9m2L7PRPIhDUIXgGtyKw575yz3lTNs6X4JXnjV+LKM/m3MydnTbtOKIjtz6VhCBq4vSm3ncdrD2lk0VgUXSVKjVDJXJzijW1RQdsU7F77He8u68koNZTz8Oz5yGa6J3H3lZ0xYgXBK2QymlWWA+RWnYhskLBv2vmE+hBMCtbA7KX5drWyRT/2JsqZ2IvfB9Y4bWDNMFbJRFmC9E74SoS0CqulwjkC0+5bpcV1CZ8NMej4pjy0U+doDQsGyo1hzVJttIjhQ7GnBtRFN1UarUlH8F3xict+HY07rEzoUGPlWcjRFRr4/gChZgc3ZL2d8oAAAAASUVORK5CYII=)!important}#toast-container.toast-bottom-center>div,#toast-container.toast-top-center>div{width:300px;margin-left:auto;margin-right:auto}#toast-container.toast-bottom-full-width>div,#toast-container.toast-top-full-width>div{width:96%;margin-left:auto;margin-right:auto}.toast{background-color:#030303}.toast-success{background-color:#51A351}.toast-error{background-color:#BD362F}.toast-info{background-color:#2F96B4}.toast-warning{background-color:#F89406}.toast-progress{position:absolute;left:0;bottom:0;height:4px;background-color:#000;opacity:.4;-ms-filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=40);filter:alpha(opacity=40)}@media all and (max-width:240px){#toast-container>div{padding:8px 8px 8px 50px;width:11em}#toast-container>div.rtl{padding:8px 50px 8px 8px}#toast-container .toast-close-button{right:-.2em;top:-.2em}#toast-container .rtl .toast-close-button{left:-.2em;right:.2em}}@media all and (min-width:241px) and (max-width:480px){#toast-container>div{padding:8px 8px 8px 50px;width:18em}#toast-container>div.rtl{padding:8px 50px 8px 8px}#toast-container .toast-close-button{right:-.2em;top:-.2em}#toast-container .rtl .toast-close-button{left:-.2em;right:.2em}}@media all and (min-width:481px) and (max-width:768px){#toast-container>div{padding:15px 15px 15px 50px;width:25em}#toast-container>div.rtl{padding:15px 50px 15px 15px}}


.base-timer {
  position: relative;
  width: 175px;
  height: 175px;
}

.base-timer__svg {
  transform: scaleX(-1);
}

.base-timer__circle {
  fill: none;
  stroke: none;
}

.base-timer__path-elapsed {
  stroke-width: 7px;
  stroke: grey;
}

.base-timer__path-remaining {
  stroke-width: 7px;
  stroke-linecap: round;
  transform: rotate(90deg);
  transform-origin: center;
  transition: 1s linear all;
  fill-rule: nonzero;
  stroke: currentColor;
}

.no-transition {
  transition: 0s linear all !important;
}


.base-timer__path-remaining.green {
  color: rgb(65, 184, 131);
}

.base-timer__path-remaining.orange {
  color: orange;
}

.base-timer__path-remaining.red {
  color: red;
}

.base-timer__label {
  position: absolute;
  width: 175px;
  height: 175px;
  top: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
}

</style>
  </head>

  <body style="padding-top:10px">




        
      <div>

        
        <main class="wrapper">
          <div class="full-bleed"><!--9 col-sm-offset-3 col-md-10 col-md-offset-2 main-->
            <!-- <div id="stones" class="" style="background-color: #333;padding-left:5%;height:157px;overflow: hidden;position:relative;top:-25px"></div> -->
          </div>
          <!-- <h1>Super 7 Infinity Saga Adventure</h1> -->
          <!-- <div  id="form"></div> -->
          <div  id="student_container"></div>
        </main>
        
      </div>

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/bootstrap.min.js"></script>
<script type="text/javascript" src="assets/js/lodash.min.js"></script>
<script type="text/javascript" src="assets/js/moment.js"></script>
<script type="text/javascript" src="assets/js/gform_bootstrap.min.js"></script>
<script type="text/javascript" src="assets/js/colorpicker.min.js"></script>
<script type="text/javascript" src="assets/js/bootstrap-datepicker.js"></script>

<script type="text/javascript" src="assets/js/ractive.min.js"></script>

<script type="text/javascript" src="assets/js/lockr.min.js"></script>
<script type="text/javascript" src="assets/js/lib.js"></script>

<script type='text/javascript' >



// Credit: Mateusz Rybczonec
const FULL_DASH_ARRAY = 283;

const TIME_LIMIT = 10;
const WARNING_THRESHOLD = TIME_LIMIT*.5;
const ALERT_THRESHOLD = TIME_LIMIT*.1;

const COLOR_CODES = {
  info: {
    color: "green"
  },
  warning: {
    color: "orange",
    threshold: WARNING_THRESHOLD
  },
  alert: {
    color: "red",
    threshold: ALERT_THRESHOLD
  }
};





$('body').keydown(function(event) {
  switch(event.keyCode) {
    case 27://escape
      cb.deactivate();
      break;
  }
});


function launchInterval(actions,interval){
  var actions = actions||[];
  var myinterval = setInterval(function(){
    if(actions.length){
      if(typeof actions[0] == "function"){
        actions.shift().call(this)
      }else{actions.shift()}
    }
    if(!actions.length){
      clearInterval(myinterval);
    }
  },interval||1000)
  return myinterval;
}

function hexToRGBArray(color)
{
    if (color.length === 3)
        color = color.charAt(0) + color.charAt(0) + color.charAt(1) + color.charAt(1) + color.charAt(2) + color.charAt(2);
    else if (color.length !== 6)
        throw('Invalid hex color: ' + color);
    var rgb = [];
    for (var i = 0; i <= 2; i++)
        rgb[i] = parseInt(color.substr(i * 2, 2), 16);
    return rgb;
}

function luma(color) // color can be a hx string or an array of RGB values 0-255
{
    var rgb = (typeof color === 'string') ? hexToRGBArray(color) : color;
    return (0.2126 * rgb[0]) + (0.7152 * rgb[1]) + (0.0722 * rgb[2]); // SMPTE C, Rec. 709 weightings
}


schedule = Lockr.get('schedule') || {students:[
{
  guid:"0",
  student:"Student 1",
  color:"blue",
  classes:[
  {start:"6:00",end:"6:30",name:"Math",color:'#0000e24f',details:"More Information"},
  {start:"7:00",end:"7:45",name:"Science",color:'#e2c458'},
  ]
},
{
  guid:"1",
  student:"Student 2",
  color:"red",  
  classes:[
  {start:"12:00",end:"12:30",name:"PE",color:'#0000e24f',details:"More Information"},
  {start:"13:00",end:"13:45",name:"Science",color:'#e2c458'},
  ]
},
{
  guid:"2",
  student:"Student 3",
  color:"purple",  
  classes:[
  {start:"6:00",end:"7:30",name:"PE",color:'#0000e24f',details:"More Information"},
  {start:"14:56",end:"15:00",name:"Science",color:'#e2c458'},
  ]
}
],
hourStart:7,
hourEnd:16
}

schedule.current = new Date();
schedule.hours = _.range(schedule.hourStart,schedule.hourEnd+1);
schedule.timers = [{TIME_LIMIT:10,note:"A3",name:"Adam"},{TIME_LIMIT:5,note:"F#",name:"Thomas"},{TIME_LIMIT:1,note:'B5',name:"Smallcomb"}];
gform.collections.add('days',["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"])

// schedule._students=_.extend([],schedule.students);
// delete schedule.students;

// Object.defineProperty(schedule, 'students',{
//   get: function(){
//     return this._students
//   },
//   set: function(value){
//     debugger;
//     this._students = value;
//     // myForm.set({dates:value})
//     Lockr.set('schedule',_.pick(schedule,'students','hourStart','hourEnd'))
//     ractive.update()

//   },enumerable: true,configurable: true
// });


// students = _.extend([],schedule.students);
// ;
// students = schedule.students
// delete schedule.students
const eventFields = [
    {label:"Name", columns:3},
    {label:'<i class="fa fa-clock-o"></i> Start',name:"start", columns:3,placeholder:"HH:MM",type:'time'},
    {label:'<i class="fa fa-clock-o"></i> End',name:"end", columns:3,placeholder:"HH:MM",type:'time'},
    {label:'<i class="fa fa-paint-brush"></i> Color', name:"color",type:"color", columns:3},
    {label:'<i class="fa fa-calendar"></i> Days',name:"days",type:"radio",size:4, multiple:true, "options": "days",
      "format": {
        "value": function(option){
          return parseInt(option.index)+1;}
      } 
    },
    {label:'<i class="fa fa-bell"></i> Alarms',name:"alarms",type:"radio",size:4, multiple:true, "options": ["Before Start","At Start","Before End","At End"]},
    {label:'Minutes Before Start',name:"before_start", columns:6,placeholder:"MM",type:'number',show:[{type:"contains",value:"Before Start",name:"alarms"}]},
    {label:'Minutes Before End',name:"before_end", columns:6,placeholder:"MM",type:'number',show:[{type:"contains",value:"Before End",name:"alarms"}]},

    {label:'<i class="fa fa-info-circle"></i> Details',name:"details", type:"textarea"},
  ];
const myForm = new gform({
  // data:schedule,
  actions:[{type:"cancel","modifiers": "btn btn-default"},{type:"button",label:"<i class=\"fa fa-trash\"></i> Delete",action:"delete","modifiers": "btn btn-danger pull-left"

},{type:"save"}],
  title:"Edit schedule",
  fields:[
  {name:"guid",type:"hidden"},
  {name:"student",label:"Name",horizontal:true},
  {label:"Color", type:"color",horizontal:true},
  {legend:"Event",name:"classes",type:"table",array:{},fields:eventFields}
  ], events:[{
    event:"initialized",
    handler:function(){
      _.each(this.filter('start').concat(this.filter('end')),function(field){
        // field.cleave = new Cleave(field.el.querySelector('input'), {
        //   time: true,
        //   timePattern: ['h', 'm', 'a']
        // });
      })
    }
  }
  ]
}).on('delete',function(e){
  schedule.students.splice(_.findIndex(schedule.students,_.pick(e.form.get(),'guid')),1)
  Lockr.set('schedule',_.pick(schedule,'students','hourStart','hourEnd'))
  ractive.set('students',schedule.students);

  e.form.trigger('close')
}).on('cancel',function(e){e.form.trigger('close')}).on('save',function(e){
  var data = e.form.get();
  if(!data.guid){
    data.guid = generateUUID();
    schedule.students.push(data)
  }else{
    schedule.students[_.findIndex(schedule.students,_.pick(data,'guid'))] = data;
  }
  Lockr.set('schedule',_.pick(schedule,'students','hourStart','hourEnd'))
  ractive.set('students',schedule.students);

  e.form.trigger('close')
});


 var template = `<div><div style="position:relative;">
  <div style="position:absolute;top:15px;bottom:25px;right:10px;left:200px">
    <div class="cursor" style="left:{{ offset(current.getMinutes(),current.getHours()) }}%;"></div>
  </div>
  <div style="border:solid 1px transparent;">
          <div style="display: table-cell;width:200px;padding:5px"></div>
          <div style="display: table-cell;width:1000px;">
            {{#each hours:num}}
              <div style="height: 100%;display:inline-block;width:10%;text-align:left;padding:0 5px;float:left;{{#if (num%2) == 0}}background-color:#eee{{/if}}">
                <b>{{ this%12||12 }}</b>
              </div>
            {{/each}}

        </div>
        </div>
        <div id="student_sort">
          {{#students}}
          <div class="sortable"  data-guid="{{guid}}">
          <div style="display: table-cell;width:200px;position:relative;padding:5px;border-right: solid 1px #eee;" ><a href="#" on-click="['personEdit', guid]"><h4>{{student}}</h4></a>
            <span style="position:absolute;top:-2px;right:5px;" class="parent-hover"><button class="move btn btn-link btn-sm" style="display:block" on-click="['movePerson', guid, 1]"><i class="fa fa-arrow-up"></i></button>
            <button class="move btn btn-link btn-sm" on-click="['movePerson', guid, -1]"><i class="fa fa-arrow-down"></i></button></span>


          </div>
          <div style="display: table-cell;width:1000px;position:relative;overflow: hidden;">
            {{#each classes:index}}
            {{#if checkDay(this)}}
              <button class="event" on-click="['eventEdit', guid, index]" style="color:#{{ contrast(color)}};outline-color:{{#soon}}yellow{{/soon}}{{#started}}green{{/started}};background:{{color}};left:{{ offset(start) }}%;width:{{ offset(end)-offset(start) }}%;">{{name}}</button>
            {{/if}}
            {{/each}}
          </div>
          </div>
        {{/students}}
        </div>

        <div style="border:solid 1px transparent;border-top-color:#aaa">
          <div style="display: table-cell;width:200px;padding:5px" on-click="['personEdit',null]"><a href="#" style="font-weight:bold;font-size:16px;"><i class="fa fa-plus text-success"></i> New Schedule</a></div>
        </div>


      </div>
      <hr>
      <div class="row">

        <div class="col-md-8">
        {{#each timers:index}}
        <div style="width:25%;display:inline-block;padding:10px;">

          {{#if !timer || !timer.isRunning()}}<button class="btn btn-success" on-click="['toggleTimer',index]"><i class="fa fa-play"></i></button>{{/if}}
          {{#if timer.isRunning()}}<button class="btn btn-danger" on-click="['toggleTimer',index]"><i class="fa fa-pause"></i></button>{{/if}}
          <button class="btn btn-default pull-right" on-click="['resetTimer',index]"><i class="fa fa-undo"></i></button>

              <div class="base-timer" on-click="['toggleTimer', index]">
          <svg class="base-timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <g class="base-timer__circle">
              <circle class="base-timer__path-elapsed" cx="50" cy="50" r="45"></circle>
              <path
                name="base-timer-path-remaining"
                stroke-dasharray="283"
                class="base-timer__path-remaining {{remainingPathColor}}"
                d="
                  M 50, 50
                  m -45, 0
                  a 45,45 0 1,0 90,0
                  a 45,45 0 1,0 -90,0
                "
              ></path>
            </g>
          </svg>
          <span name="base-timer-label" class="base-timer__label">{{formatTime(this.TIME_LIMIT)}}</span>
        </div>
        {{#if !timer || !timer.isRunning()}}<button class="btn btn-info" on-click="['editTimer',index]"><i class="fa fa-pencil"></i> Edit</button>{{/if}}
        <h6 class="pull-right">{{name}}</h6>

        </div>

        {{/each}}

        </div>

        <div class="col-md-4">
          <ul class="list-group">
            <li class="list-group-item">Cras justo odio</li>
          </ul>
        </div>
      </div>
    </div>
    `
      schedule.remainingPathColor=COLOR_CODES.info.color;

      schedule.checkDay=function(e){
      if(typeof e.days !== 'undefined' && e.days.indexOf(schedule.current.getDay()) <0 ){
        return false
      }
      return true;
    }
    schedule.offset= function(mins, hours){
      if(typeof mins == 'string'){
        [hours,mins,meridian] = mins.split(':');
        if(typeof mins == 'string' && mins.length>2){ [mins,meridian] = mins.split(' ');}

        hours = +hours%12
        if(meridian == "PM") hours+=12;
      }

      // return (typeof hours == "undefined")?(+mins*10)/6 :  
      
      var offset = (hours-schedule.hourStart)*10+((+mins*1)/6)
      return (offset >0)?offset:0;
    }
    schedule.contrast =function(color){
     return (luma(color.split('#')[1]) >= 165) ? '000' : 'fff';
    }

    schedule.formatTime = function(time) {
      time = time
      const minutes = Math.floor(time / 60);
      let seconds = time % 60;

      if (seconds < 10) {
        seconds = `0${seconds}`;
      }

      return `${minutes}:${seconds}`;
    }






// let timePassed = 0;
// let timerInterval = null;

// schedule.timeleft = TIME_LIMIT;
// schedule.remainingPathColor = COLOR_CODES.info.color;


ractive = Ractive({
  target: "#student_container",
  template: template,
  observe: {
    'students' (newValue) {
      console.log('students changed to', newValue)
    }
  },
  on:{
    personEdit:function(context, guid){
      myForm.set(schedule.students[_.findIndex(schedule.students,{guid:guid})]||null).modal()
    },
    eventEdit:function(context, guid, index){
      new gform({
        data:schedule.students[_.findIndex(schedule.students,{guid:guid})].classes[index],
        title:"Edit Event",
        fields:eventFields}
      ).on('cancel',function(e){e.form.trigger('close')}).on('save',function(guid,index,e){
        schedule.students[_.findIndex(schedule.students,{guid:guid})].classes[index] = e.form.get();

        Lockr.set('schedule',_.pick(schedule,'students','hourStart','hourEnd'))
        ractive.set('students',schedule.students);
        e.form.trigger('close');

      }.bind(null,guid,index)).modal()
    },
    movePerson:function(context, guid, direction){
      var index = _.indexOf(schedule.students,_.find(schedule.students,{guid:guid}))
      if(typeof schedule.students[index-(direction||1)] == 'undefined')return;

      var old = schedule.students.splice(index,1)
      schedule.students.splice(index-(direction||1),0,old[0])
      context.ractive.update();
      Lockr.set('schedule',_.pick(schedule,'students','hourStart','hourEnd'))

    },
    toggleTimer:function(context,index){
      if(typeof schedule.timers[index].timer  == 'undefined'){
        schedule.timers[index].timer = new timeManager(index);
      }else{

        if(schedule.timers[index].timer.isRunning()){
          schedule.timers[index].timer.pause();
        }else{
          schedule.timers[index].timer.resume();
        }
      }
      context.ractive.update();

    },
    resetTimer:function(context,index){
      schedule.timers[index].timer.reset();
      context.ractive.update();
    },
    editTimer:function(context, index){
      schedule.timers[index].form = new gform({
        actions:[{type:"cancel","modifiers": "btn btn-default"},{type:"button",label:"<i class=\"fa fa-trash\"></i> Delete",action:"delete","modifiers": "btn btn-danger pull-left"

},{type:"save"}],
        data:schedule.timers[index],
        title:"Edit Alarm",
        fields:[
        {name:"TIME_LIMIT",label:"Timer Length",type:"number",help:"seconds",placeholder:"00"},
        {name:"note",label:"Alarm Note",type:"text",placeholder:"C#4"},
        {label:"Name"},
          {type:"hidden",name:"index",value:index}
        ]
      }).on('cancel',function(e){e.form.trigger('close');}).on('save',function(e){
        schedule.timers[e.form.get('index')] = _.omit(e.form.get(),'index');
        ractive.update();
        e.form.trigger('close');
      }).on('delete', function(e){
        schedule.timers.splice(e.form.get('index'),1)
        // Lockr.set('schedule',_.pick(schedule,'students','hourStart','hourEnd'))
        ractive.set('timers',schedule.timers);

        e.form.trigger('close')
      }).modal()
    }
  },
  data: schedule
});


// var sortFunction = function (/**Event*/evt) {
//   clearTimeout(timer)
//   // source = ractive.get("students");

//   ractive.sort('students',function(list,a, b) {
//     return list.indexOf(a.guid) - list.indexOf(b.guid);
//   }.bind(null,_.map(document.querySelectorAll('.sortable'),function(item){return item.dataset.guid})))



  schedule.students.sort(function(list,a, b) {
    return list.indexOf(a.guid) - list.indexOf(b.guid);
  }.bind(null,_.map(document.querySelectorAll('.sortable'),function(item){return item.dataset.guid})));
  
//   sorter.destroy();
//   delete sorter;
//   Lockr.set('schedule',_.pick(schedule,'students','hourStart','hourEnd'))
//   // source = schedule.students;
//   // ractive.updateModel('students',schedule.students)
//   // while(document.body.querySelector("#students > div").querySelector('sortable')){
//   //   document.body.querySelector("#students > div").querySelector('sortable').remove();
//   // }
//   // ractive.render()
//   sorter = new Sortable(document.body.querySelector("#student_sort"),{draggable:'.sortable',onSort: sortFunction})
//   startup();
// }

// sorter = new Sortable(document.body.querySelector("#student_sort"),{draggable:'.sortable',onSort: sortFunction})

            



var beep = function(note, octave) {
  var octave = octave || 4;

  if(typeof note == 'number'){
    frequency = note;
  }
  if(typeof note == 'string'){
    if(!isNaN(parseInt(note.slice(-1)))){
      octave = parseInt(note.slice(-1));
      note = note.slice(0,-1)
    }
      
    const notes = [[16.35,17.32,18.35,19.45,20.60,21.83,23.12,24.50,25.96,27.50,29.14,30.87],
    [32.70,34.65,36.71,38.89,41.20,43.65,46.25,49.00,51.91,55.00,58.27,61.74],
    [65.41,69.30,73.42,77.78,82.41,87.31,92.50,98.00,103.8,110.0,116.5,123.5],
    [130.8,138.6,146.8,155.6,164.8,174.6,185.0,196.0,207.7,220.0,233.1,246.9],
    [261.6,277.2,293.7,311.1,329.6,349.2,370.0,392.0,415.3,440.0,466.2,493.9],
    [523.3,554.4,587.3,622.3,659.3,698.5,740.0,784.0,830.6,880.0,932.3,987.8],
    [1047,1109,1175,1245,1319,1397,1480,1568,1661,1760,1865,1976],
    [2093,2217,2349,2489,2637,2794,2960,3136,3322,3520,3729,3951],
    [4186,4435,4699,4978,5274,5588,5920,6272,6645,7040,7459,7902]]
    
    frequency = notes[octave][["C","C#","D","Eb","E","F","F#","G","G#","A","Bb","B"].indexOf(note)||0];
  }

  return function(frequency){
    var context = new AudioContext()
    var o = context.createOscillator()
    var frequency = frequency || 440.0;
    o.frequency.value = frequency;

    var  g = context.createGain()
    o.connect(g)
    g.connect(context.destination)
    o.start(0)
    var X = 1;
    g.gain.exponentialRampToValueAtTime(0.00001, context.currentTime + X)
  }.bind(null, frequency)
}
var startup = function() {
  if(typeof timer !== 'undefined')clearTimeout(timer);
        schedule.current = new Date();
        schedule.currentMins = ((schedule.current.getUTCHours()*60)-schedule.current.getTimezoneOffset())+schedule.current.getUTCMinutes();
        _.each(schedule.students,function(student){
          student.classes = _.sortBy(student.classes,'start')
          _.each(student.classes,function(session){
            [hours, mins, meridian] = session.start.split(':')

            if(typeof mins == 'string' && mins.length>2){ [mins,meridian] = mins.split(' ');}

            hours = +hours%12
            if(meridian == "PM") hours+=12;

            var deltaStart = ((+hours*60)+ +mins) - schedule.currentMins;
            
            [hours, mins,meridian] = session.end.split(':')

            if(typeof mins == 'string' && mins.length>2){ [mins,meridian] = mins.split(' ');}

            hours = +hours%12
            if(meridian == "PM") hours+=12;
        
            var deltaEnd = ((hours*60)+ +mins) - schedule.currentMins;

            if(deltaStart > 0 && deltaStart <= 10){
              console.log(session.name)

              //Check is active today
              debugger;
              if(typeof session.days !== 'undefined' && session.days.indexOf(schedule.current.getDay()) >=0 ){

                //check that it starts in ten minutes and has not chimed yet
                if(!session.soon && deltaStart == 10){
                  // launchInterval([beep(261.6),beep(830.6),beep(440),beep(440),beep(987.8),beep(440)],300)
                  launchInterval([beep(261.6),beep(830.6),beep(440),beep(987.8)],300)

                }
                    
                toastr.warning(student.student +' has ' +session.name+" comming up in "+deltaStart+' minutes.')

                session.soon = true;

              }
            }

            if(deltaStart <= 0){
              session.soon = false;
              session.started = true;
            }
            if(deltaEnd<0){
              session.soon = false;
              session.started = false;
            }
          })
        })
        // console.log(schedule.students[0].student)
        ractive.update(_.omit(schedule,'students'));
        // ractive.update('students',schedule.students);
        
        timer = setTimeout(startup, 10000);
    }






// Credit: Mateusz Rybczonec
// const FULL_DASH_ARRAY = 283;

// const TIME_LIMIT = 10;
// const WARNING_THRESHOLD = TIME_LIMIT*.5;
// const ALERT_THRESHOLD = TIME_LIMIT*.1;



 timeManager = function(index){
   index = index||0;
  
  const { alert, warning, info } = COLOR_CODES;
  
  var data = schedule.timers[index];
  data.note = data.note ||'F#'
  var timeleft = data.TIME_LIMIT;

  let timePassed = 0;
  this.remainingPathColor = COLOR_CODES.info.color;

  var running = true;

  startTimer = function(){
    return setInterval(() => {
    timePassed = timePassed += 1;
    timeleft = data.TIME_LIMIT - timePassed;
    document.querySelectorAll("[name=base-timer-label]")[index].innerHTML = schedule.formatTime(
      timeleft
    );
    setCircleDasharray();
    setRemainingPathColor(timeleft);

    if (timeleft === 0) {
      clearInterval(timerInterval);
      
      launchInterval([beep(data.note),beep(data.note),beep(data.note),,,,beep(data.note),beep(data.note),beep(data.note)],150)
    }
  }, 1000);
  }
  var timerInterval = startTimer();

  function setRemainingPathColor(id) {
    const { alert, warning, info } = COLOR_CODES;
    this.remainingPathColor = (timeleft <= alert.threshold)?alert.color:(this.timeleft <= warning.threshold)?warning.color:info.color
    ractive.update();
  }

  function calculateTimeFraction() {
    const rawTimeFraction = timeleft / data.TIME_LIMIT;
    return rawTimeFraction - (1 / data.TIME_LIMIT) * (1 - rawTimeFraction);
  }

  function setCircleDasharray() {
    const circleDasharray = `${(
      calculateTimeFraction() * FULL_DASH_ARRAY
    ).toFixed(0)} 283`;
    document
      .querySelectorAll("[name=base-timer-path-remaining]")[index]
      .setAttribute("stroke-dasharray", circleDasharray);
  }



return {
  pause:function(){
    running = false;

    clearInterval(timerInterval);
  },
  resume:function(){
    running = true;
    timerInterval = startTimer();
  },isRunning:function(){
    return running;
  },reset:function(){
    running = false;
    clearInterval(timerInterval);

    data = schedule.timers[index];
    timeleft = data.TIME_LIMIT;

    timePassed = 0;
    remainingPathColor = COLOR_CODES.info.color;
    document.querySelectorAll("[name=base-timer-label]")[index].innerHTML = schedule.formatTime(
      timeleft
    );
    setCircleDasharray();
    document.querySelectorAll("[name=base-timer-path-remaining]")[index].classList.add('.no-transition')
    document.querySelectorAll("[name=base-timer-path-remaining]")[index].setAttribute("stroke-dasharray", '283 283');
    document.querySelectorAll("[name=base-timer-path-remaining]")[index].classList.remove('.no-transition');
   
    setRemainingPathColor(timeleft);
  }
}



 }


// function onTimesUp() {
//   clearInterval(timerInterval);
// }

// startTimer = function () {
  
//   timerInterval = setInterval(() => {
//     timePassed = timePassed += 1;
//     schedule.timeleft = TIME_LIMIT - timePassed;
//     document.getElementById("base-timer-label").innerHTML = schedule.formatTime(
//       schedule.timeleft
//     );
//     setCircleDasharray();
//     setRemainingPathColor(schedule.timeleft);

//     if (schedule.timeleft === 0) {
//       // onTimesUp();
//       clearInterval(timerInterval);
//       launchInterval([beep(261.6),beep(830.6),beep(440),beep(987.8)],300)

//     }
//   }, 1000);
// }


// function setRemainingPathColor(id) {
//   const { alert, warning, info } = COLOR_CODES;
//   schedule.remainingPathColor = (schedule.timeleft <= alert.threshold)?alert.color:(schedule.timeleft <= warning.threshold)?warning.color:info.color
//   ractive.update();
// }

// function calculateTimeFraction(timeleft) {
//   const rawTimeFraction = schedule.timeleft / TIME_LIMIT;
//   return rawTimeFraction - (1 / TIME_LIMIT) * (1 - rawTimeFraction);
// }

// function setCircleDasharray() {
//   const circleDasharray = `${(
//     calculateTimeFraction() * FULL_DASH_ARRAY
//   ).toFixed(0)} 283`;
//   document
//     .getElementById("base-timer-path-remaining")
//     .setAttribute("stroke-dasharray", circleDasharray);
// }









startup();
// startTimer();
</script>

  </body>
</html>

